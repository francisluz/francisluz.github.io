<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"/><link rel="manifest" href="/favicon/site.webmanifest"/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000"/><link rel="shortcut icon" href="/favicon/favicon.ico"/><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-config" content="/favicon/browserconfig.xml"/><meta name="theme-color" content="#000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><meta name="description" content="Francis Luz - I&#x27;m Full-Stack software engineer."/><meta property="og:image" content="/favicon/apple-touch-icon.png"/><meta name="apple-mobile-web-app-title" content="Francis Luz"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="default"/><link href="splashscreens-light/iphone5_splash.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (prefers-color-scheme: light)" rel="apple-touch-startup-image"/><link href="splashscreens-light/iphone6_splash.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (prefers-color-scheme: light)" rel="apple-touch-startup-image"/><link href="splashscreens-light/iphoneplus_splash.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3) and (prefers-color-scheme: light)" rel="apple-touch-startup-image"/><link href="splashscreens-light/iphonex_splash.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (prefers-color-scheme: light)" rel="apple-touch-startup-image"/><link href="splashscreens-light/iphonexr_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (prefers-color-scheme: light)" rel="apple-touch-startup-image"/><link href="splashscreens-light/iphonexsmax_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (prefers-color-scheme: light)" rel="apple-touch-startup-image"/><link href="splashscreens-light/ipad_splash.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (prefers-color-scheme: light)" rel="apple-touch-startup-image"/><link href="splashscreens-light/ipadpro1_splash.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (prefers-color-scheme: light)" rel="apple-touch-startup-image"/><link href="splashscreens-light/ipadpro3_splash.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (prefers-color-scheme: light)" rel="apple-touch-startup-image"/><link href="splashscreens-light/ipadpro2_splash.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (prefers-color-scheme: light)" rel="apple-touch-startup-image"/><link href="splashscreens-dark/iphone5_splash.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (prefers-color-scheme: dark)" rel="apple-touch-startup-image"/><link href="splashscreens-dark/iphone6_splash.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (prefers-color-scheme: dark)" rel="apple-touch-startup-image"/><link href="splashscreens-dark/iphoneplus_splash.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3) and (prefers-color-scheme: dark)" rel="apple-touch-startup-image"/><link href="splashscreens-dark/iphonex_splash.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (prefers-color-scheme: dark)" rel="apple-touch-startup-image"/><link href="splashscreens-dark/iphonexr_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (prefers-color-scheme: dark)" rel="apple-touch-startup-image"/><link href="splashscreens-dark/iphonexsmax_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (prefers-color-scheme: dark)" rel="apple-touch-startup-image"/><link href="splashscreens-dark/ipad_splash.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (prefers-color-scheme: dark)" rel="apple-touch-startup-image"/><link href="splashscreens-dark/ipadpro1_splash.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (prefers-color-scheme: dark)" rel="apple-touch-startup-image"/><link href="splashscreens-dark/ipadpro3_splash.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (prefers-color-scheme: dark)" rel="apple-touch-startup-image"/><link href="splashscreens-dark/ipadpro2_splash.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (prefers-color-scheme: dark)" rel="apple-touch-startup-image"/><title>How to integrate container security scan with AWS Elastic Search and Kibana | Francis Luz</title><meta property="og:image" content="/assets/blog/aws-elastic-search-aqua-security/cover.jpg"/><meta name="next-head-count" content="39"/><link rel="preload" href="/_next/static/css/10f306cfd1b7460a80e7.css" as="style"/><link rel="stylesheet" href="/_next/static/css/10f306cfd1b7460a80e7.css"/><link rel="preload" href="/_next/static/css/996a3fe466731df91522.css" as="style"/><link rel="stylesheet" href="/_next/static/css/996a3fe466731df91522.css"/><link rel="preload" href="/_next/static/chunks/main-f00071751833783f30ee.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-488dc228921f1fdbc0e7.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.d557686129d5a5cc0c94.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.c326fb833cc5579beb78.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-f736c612c3a61f7a792b.js" as="script"/><link rel="preload" href="/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.d59a000dff2aebf41917.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bslug%5D-aa8a6a91975836f2c26b.js" as="script"/></head><body><div id="__next"><div class="min-h-screen"><main><div class="container mx-auto px-5"><h2 class="text-3xl md:text-4xl font-bold tracking-tight md:tracking-tighter leading-tight mb-20 mt-8"><a class="hover:underline" href="/"><img src="/images/left-arrow-back-dark.svg" alt="logo" class="w-6 my-1 md:my-2 float-left block lg:hidden light:hidden"/><img src="/images/left-arrow-back.svg" alt="logo" class="w-6 my-3 pr-1 md:my-2 float-left block lg:hidden dark:hidden"/><img src="/images/logo-dark.svg" alt="logo" class="w-8 md:w-10 float-left hidden dark:block"/><img src="/images/logo.svg" alt="logo" class="w-8 md:w-10 float-left dark:hidden"/><span class="pl-2">Francis Luz</span></a></h2><article class="mb-32"><h1 class="text-6xl md:text-7xl lg:text-8xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">How to integrate container security scan with AWS Elastic Search and Kibana</h1><div class="hidden md:block md:mb-12"><div class="flex items-center"><img src="/assets/blog/authors/francis.jpg" class="w-12 h-12 rounded-full mr-4" alt="Francis Luz"/><div class="text-xl font-bold">Francis Luz</div></div></div><div class="mb-8 md:mb-16 -mx-5 sm:mx-0"><div class="mx-0"><img src="/assets/blog/aws-elastic-search-aqua-security/cover.jpg" alt="Cover Image for How to integrate container security scan with AWS Elastic Search and Kibana" class="shadow-small dark:shadow-smallDark"/></div></div><div class="max-w-2xl mx-auto"><div class="block md:hidden mb-6"><div class="flex items-center"><img src="/assets/blog/authors/francis.jpg" class="w-12 h-12 rounded-full mr-4" alt="Francis Luz"/><div class="text-xl font-bold">Francis Luz</div></div></div><div class="mb-6 text-lg"><time dateTime="2020-08-05T22:02:28.274Z">August	5, 2020</time></div></div><div class="max-w-2xl mx-auto"><div class="markdown-styles_markdown__1x9gM"><h2>AWS Elastic Search with Cognito (for Kibana), Lambda and Aqua Security (kube-bench) Reports</h2>
<h1>Using Cloudformation templates to manange the cloud stack</h1>
<p><a 
  href="https://github.com/francisluz/aws-elasticsearch-cognito-aquasec" 
  target="_blank" 
  class="mx-2 font-bold">
<img src="https://cdn.jsdelivr.net/npm/simple-icons@3.0.1/icons/github.svg" 
    alt="GitHub Repo" height="22px" width="22px" class="inline mr-2 fill-current"/>
GitHub Repo
</a></p>
<img src="https://raw.githubusercontent.com/francisluz/aws-elasticsearch-cognito-aquasec/master/images/AWS-ES-Kibana-Diagram.png" alt="AWS Elastic Search with Cognito and Kibana Diagram">
<p>The idea of this project is to put together all resources needed to create a Elastic Search cluster with Kibana as visualition tool. </p>
<p>Which will ingest data reports from Aqua Security kube-bench a Container Security monitor.</p>
<h1>Table of Contents</h1>
<ul>
<li><a href="#prerequisites">Prerequisites</a><ul>
<li><a href="#execution-rights">Execution rights</a></li>
</ul></li>
<li><a href="#aws-elastic-search">AWS Elastic Search</a><ul>
<li>Components</li>
<li>Deployments</li>
<li>Cluster for Production</li>
<li>Execution</li>
</ul></li>
<li><a href="#kibana-with-cognito">Kibana with Cognito</a><ul>
<li>Cognito</li>
</ul></li>
<li><a href="#lambda-with-s3">Lambda with S3</a><ul>
<li>Components</li>
<li>Deployments</li>
<li>Execution</li>
</ul></li>
<li><a href="#aws-eks-cluster">AWS EKS Cluster</a></li>
<li><a href="#integration-test">Integration Test</a></li>
</ul>
<h2>Prerequisites</h2>
<p>We will need the basic <a href="https://aws.amazon.com/cli/"><strong>AWS CLI</strong></a> setup.</p>
<p>If you don't have a AWS Account here's good guide: <a href="https://serverless.com/framework/docs/providers/aws/guide/credentials/">Creating AWS Credetials</a>.</p>
<p>Basic commands to setup your AWS CLI.</p>
<pre><code class="hljs language-bash">pip install awscli
aws --version
aws configure
aws iam get-user

<span class="hljs-comment"># Check Elastic Search versions to see which one suits you best</span>
aws es list-elasticsearch-versions
aws es list-elasticsearch-instance-types --elasticsearch-version 7.1</code></pre>
<h3>Execution rights</h3>
<p>To be able to run the <strong><code>.sh</code></strong> deployment files you may need to give them rights.</p>
<p>Example:</p>
<pre><code class="hljs language-sh">chmod +x ./deploy.sh</code></pre>
<h2>AWS Elastic Search</h2>
<p>The launch of AWS Elastic Search cluster, involves a set of resources needed in order to acomplish the main goal which is release the cluster with security.</p>
<h3>Components</h3>
<p>All the components needed are setup in the cloudformation template <strong><code>aws-es-domain.yml</code></strong>.</p>
<ul>
<li>IAM Roles</li>
<li>Cognito User Pool</li>
<li>Congnito Identity Pool</li>
<li>Elastic Search Domain</li>
</ul>
<h3>Deployment</h3>
<p>Before you run provide your unique values by changing the parameters at <strong><code>deploy.sh</code></strong>: </p>
<ul>
<li>&#x3C;GLOBAL_UNIQUE_DOMAIN_NAME></li>
<li>&#x3C;UNIQUE_POOL_NAME></li>
<li>&#x3C;GLOBAL_UNIQUE_POOL_DOMAIN></li>
</ul>
<h3>Cluster for Production</h3>
<p>If your aim is to deploy the cluster in production or simulate a more powerfull one you need to uncomment the lines in the section <strong><code>ElasticsearchDomain</code></strong> at:</p>
<ul>
<li>aws-es-domain.yml</li>
</ul>
<pre><code class="hljs language-yml"><span class="hljs-attr">ZoneAwarenessEnabled:</span> <span class="hljs-string">"true"</span>
<span class="hljs-attr">DedicatedMasterEnabled:</span> <span class="hljs-string">"true"</span>
<span class="hljs-attr">DedicatedMasterType:</span> <span class="hljs-string">"t2.small.elasticsearch"</span>
<span class="hljs-attr">DedicatedMasterCount:</span> <span class="hljs-string">"1"</span></code></pre>
<h3>Execution</h3>
<p>The deployment can take from 10 to 15 minutes to finish.</p>
<p><strong>Run</strong></p>
<pre><code class="hljs language-sh">./deploy.sh</code></pre>
<h2>Kibana with Cognito</h2>
<p>The Kibana setup is verify straight forward now that you have deploy the main Elastic Search script.</p>
<p>Create an user in your User Pool by accessing the AWS Console.</p>
<h3>Cognito</h3>
<ul>
<li>Manager User Pools</li>
<li>Your pool<ul>
<li><strong>Users and groups</strong> \
Setup the User name and Password.</li>
</ul></li>
</ul>
<h2>Lambda with S3</h2>
<p>The Lambda function is the code that will stream the data to Elastic Search via <strong>S3 Trigger</strong>.</p>
<h3>Components</h3>
<ul>
<li>AWS S3</li>
<li>IAM Role</li>
<li>Lambda Function (Python 3.7)</li>
</ul>
<h3>Deployment</h3>
<p>Fist of all execute the <strong><code>deploy-bucket.sh</code></strong> to create the bucket base for the lambda.</p>
<p>Update the <strong>lambda function</strong> with the new Elastic Search host name at <strong><code>lambda/s3-to-es.py</code></strong>.</p>
<p>After the execution of the bucket deployment it will gerenate the <strong><code>bucket name</code></strong> that you will need to execute the next step.</p>
<p>Now you have to update the parameters with the value from the previous step at <strong><code>deploy-lambda.sh</code></strong> and also inform the name of your <strong>ingestion bucket</strong>:</p>
<ul>
<li>--s3-bucket &#x3C;YOUR_BUCKET_NAME></li>
<li>&#x3C;INGESTION_BUCKET_NAME></li>
</ul>
<h3>Execution</h3>
<p>This process will create the <strong>insgestion bucket</strong>,
package, deploy the lambda and create the trigger event between S3 and the function.</p>
<p><strong>Run</strong></p>
<pre><code class="hljs language-sh">./deploy-lambda.sh</code></pre>
<h2>AWS EKS Cluster</h2>
<p>This step is optional if you already have it setup in your environment, and I also provide a sample file at <strong><code>aquasec-log/kube-bench-report.json</code></strong> that you can test the ingestion workflow without having to launche a new cluster.</p>
<p>For this section you can follow the steps defined on <a href="https://github.com/aquasecurity/kube-bench#running-in-an-eks-cluster"><strong>kube-bench</strong></a> repository.</p>
<p><strong>Notice</strong>: In the file <code>job-eks.yml</code> at the <strong>command</strong> line add the <code>--json</code> flag to generate the correct output.</p>
<pre><code class="hljs language-sh"><span class="hljs-built_in">command</span>: [<span class="hljs-string">"kube-bench"</span>, <span class="hljs-string">"--version"</span>, <span class="hljs-string">"1.11"</span>, <span class="hljs-string">"--json"</span>]</code></pre>
<p>Based on the main repo guide you can find a sample deployment script here:</p>
<ul>
<li><strong><code>deploy-aws-eks.sh</code></strong></li>
</ul>
<h2>Integration Test</h2>
<p>To complete the integration test create a folder <strong><code>load</code></strong> inside of you <strong>ingestion bucket</strong> and then <strong>upload</strong> the sample file:</p>
<ul>
<li><strong><code>aquasec-log/kube-bench-report.json</code></strong></li>
</ul>
<p>After the upload it should trigger the lambda and create a new index on Elastic Search.</p>
<p>Access your <strong>Kibana</strong> and check your new index there.</p>
<h2>Cloud Cleanup</h2>
<p>As we are using Cloudformation which track the changesets, you're able to rollback and delete any resource used. Go to the AWS Console and <strong>Cloud Formation</strong>.</p>
<p>#aws #aws-es #aws-eks #aws-lambda #aws-s3 #shell-script #python</p>
</div></div></article></div></main></div><footer class="bg-accent-1 border-t border-accent-2 dark:bg-accent-1-dark dark:border-accent-2-dark"><div class="container mx-auto px-5"><div class="py-28 flex flex-col lg:flex-row items-center"><h3 class="text-4xl lg:text-5xl font-bold tracking-tighter leading-tight text-center lg:text-left mb-10 lg:mb-0 lg:pr-4 lg:w-1/2">Sharing some Ideas.</h3><div class="flex flex-col lg:flex-row justify-end items-center lg:pl-4 lg:w-1/2"><span>You can find more on my<a href="https://github.com/francisluz/" target="_blank" class="mx-1 font-bold hover:underline"><svg role="img" class="fill-current inline-block h-8 w-8" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg>GitHub</a>and<a href="https://www.linkedin.com/in/francisluz/" target="_blank" class="mx-2 font-bold hover:underline"><svg role="img" class="fill-current inline-block h-8 w-8" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn icon</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg>Linkedin</a>profile.</span></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"How to integrate container security scan with AWS Elastic Search and Kibana","date":"2020-08-05T22:02:28.274Z","slug":"aws-elastic-search-aqua-security","author":{"name":"Francis Luz","picture":"/assets/blog/authors/francis.jpg"},"content":"\u003ch2\u003eAWS Elastic Search with Cognito (for Kibana), Lambda and Aqua Security (kube-bench) Reports\u003c/h2\u003e\n\u003ch1\u003eUsing Cloudformation templates to manange the cloud stack\u003c/h1\u003e\n\u003cp\u003e\u003ca \n  href=\"https://github.com/francisluz/aws-elasticsearch-cognito-aquasec\" \n  target=\"_blank\" \n  class=\"mx-2 font-bold\"\u003e\n\u003cimg src=\"https://cdn.jsdelivr.net/npm/simple-icons@3.0.1/icons/github.svg\" \n    alt=\"GitHub Repo\" height=\"22px\" width=\"22px\" class=\"inline mr-2 fill-current\"/\u003e\nGitHub Repo\n\u003c/a\u003e\u003c/p\u003e\n\u003cimg src=\"https://raw.githubusercontent.com/francisluz/aws-elasticsearch-cognito-aquasec/master/images/AWS-ES-Kibana-Diagram.png\" alt=\"AWS Elastic Search with Cognito and Kibana Diagram\"\u003e\n\u003cp\u003eThe idea of this project is to put together all resources needed to create a Elastic Search cluster with Kibana as visualition tool. \u003c/p\u003e\n\u003cp\u003eWhich will ingest data reports from Aqua Security kube-bench a Container Security monitor.\u003c/p\u003e\n\u003ch1\u003eTable of Contents\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#prerequisites\"\u003ePrerequisites\u003c/a\u003e\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#execution-rights\"\u003eExecution rights\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#aws-elastic-search\"\u003eAWS Elastic Search\u003c/a\u003e\u003cul\u003e\n\u003cli\u003eComponents\u003c/li\u003e\n\u003cli\u003eDeployments\u003c/li\u003e\n\u003cli\u003eCluster for Production\u003c/li\u003e\n\u003cli\u003eExecution\u003c/li\u003e\n\u003c/ul\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#kibana-with-cognito\"\u003eKibana with Cognito\u003c/a\u003e\u003cul\u003e\n\u003cli\u003eCognito\u003c/li\u003e\n\u003c/ul\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#lambda-with-s3\"\u003eLambda with S3\u003c/a\u003e\u003cul\u003e\n\u003cli\u003eComponents\u003c/li\u003e\n\u003cli\u003eDeployments\u003c/li\u003e\n\u003cli\u003eExecution\u003c/li\u003e\n\u003c/ul\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#aws-eks-cluster\"\u003eAWS EKS Cluster\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#integration-test\"\u003eIntegration Test\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003ePrerequisites\u003c/h2\u003e\n\u003cp\u003eWe will need the basic \u003ca href=\"https://aws.amazon.com/cli/\"\u003e\u003cstrong\u003eAWS CLI\u003c/strong\u003e\u003c/a\u003e setup.\u003c/p\u003e\n\u003cp\u003eIf you don't have a AWS Account here's good guide: \u003ca href=\"https://serverless.com/framework/docs/providers/aws/guide/credentials/\"\u003eCreating AWS Credetials\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eBasic commands to setup your AWS CLI.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003epip install awscli\naws --version\naws configure\naws iam get-user\n\n\u003cspan class=\"hljs-comment\"\u003e# Check Elastic Search versions to see which one suits you best\u003c/span\u003e\naws es list-elasticsearch-versions\naws es list-elasticsearch-instance-types --elasticsearch-version 7.1\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eExecution rights\u003c/h3\u003e\n\u003cp\u003eTo be able to run the \u003cstrong\u003e\u003ccode\u003e.sh\u003c/code\u003e\u003c/strong\u003e deployment files you may need to give them rights.\u003c/p\u003e\n\u003cp\u003eExample:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sh\"\u003echmod +x ./deploy.sh\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eAWS Elastic Search\u003c/h2\u003e\n\u003cp\u003eThe launch of AWS Elastic Search cluster, involves a set of resources needed in order to acomplish the main goal which is release the cluster with security.\u003c/p\u003e\n\u003ch3\u003eComponents\u003c/h3\u003e\n\u003cp\u003eAll the components needed are setup in the cloudformation template \u003cstrong\u003e\u003ccode\u003eaws-es-domain.yml\u003c/code\u003e\u003c/strong\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIAM Roles\u003c/li\u003e\n\u003cli\u003eCognito User Pool\u003c/li\u003e\n\u003cli\u003eCongnito Identity Pool\u003c/li\u003e\n\u003cli\u003eElastic Search Domain\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eDeployment\u003c/h3\u003e\n\u003cp\u003eBefore you run provide your unique values by changing the parameters at \u003cstrong\u003e\u003ccode\u003edeploy.sh\u003c/code\u003e\u003c/strong\u003e: \u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u0026#x3C;GLOBAL_UNIQUE_DOMAIN_NAME\u003e\u003c/li\u003e\n\u003cli\u003e\u0026#x3C;UNIQUE_POOL_NAME\u003e\u003c/li\u003e\n\u003cli\u003e\u0026#x3C;GLOBAL_UNIQUE_POOL_DOMAIN\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eCluster for Production\u003c/h3\u003e\n\u003cp\u003eIf your aim is to deploy the cluster in production or simulate a more powerfull one you need to uncomment the lines in the section \u003cstrong\u003e\u003ccode\u003eElasticsearchDomain\u003c/code\u003e\u003c/strong\u003e at:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eaws-es-domain.yml\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yml\"\u003e\u003cspan class=\"hljs-attr\"\u003eZoneAwarenessEnabled:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eDedicatedMasterEnabled:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"true\"\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eDedicatedMasterType:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"t2.small.elasticsearch\"\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003eDedicatedMasterCount:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"1\"\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3\u003eExecution\u003c/h3\u003e\n\u003cp\u003eThe deployment can take from 10 to 15 minutes to finish.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eRun\u003c/strong\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sh\"\u003e./deploy.sh\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eKibana with Cognito\u003c/h2\u003e\n\u003cp\u003eThe Kibana setup is verify straight forward now that you have deploy the main Elastic Search script.\u003c/p\u003e\n\u003cp\u003eCreate an user in your User Pool by accessing the AWS Console.\u003c/p\u003e\n\u003ch3\u003eCognito\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eManager User Pools\u003c/li\u003e\n\u003cli\u003eYour pool\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eUsers and groups\u003c/strong\u003e \\\nSetup the User name and Password.\u003c/li\u003e\n\u003c/ul\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eLambda with S3\u003c/h2\u003e\n\u003cp\u003eThe Lambda function is the code that will stream the data to Elastic Search via \u003cstrong\u003eS3 Trigger\u003c/strong\u003e.\u003c/p\u003e\n\u003ch3\u003eComponents\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eAWS S3\u003c/li\u003e\n\u003cli\u003eIAM Role\u003c/li\u003e\n\u003cli\u003eLambda Function (Python 3.7)\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eDeployment\u003c/h3\u003e\n\u003cp\u003eFist of all execute the \u003cstrong\u003e\u003ccode\u003edeploy-bucket.sh\u003c/code\u003e\u003c/strong\u003e to create the bucket base for the lambda.\u003c/p\u003e\n\u003cp\u003eUpdate the \u003cstrong\u003elambda function\u003c/strong\u003e with the new Elastic Search host name at \u003cstrong\u003e\u003ccode\u003elambda/s3-to-es.py\u003c/code\u003e\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eAfter the execution of the bucket deployment it will gerenate the \u003cstrong\u003e\u003ccode\u003ebucket name\u003c/code\u003e\u003c/strong\u003e that you will need to execute the next step.\u003c/p\u003e\n\u003cp\u003eNow you have to update the parameters with the value from the previous step at \u003cstrong\u003e\u003ccode\u003edeploy-lambda.sh\u003c/code\u003e\u003c/strong\u003e and also inform the name of your \u003cstrong\u003eingestion bucket\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e--s3-bucket \u0026#x3C;YOUR_BUCKET_NAME\u003e\u003c/li\u003e\n\u003cli\u003e\u0026#x3C;INGESTION_BUCKET_NAME\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003eExecution\u003c/h3\u003e\n\u003cp\u003eThis process will create the \u003cstrong\u003einsgestion bucket\u003c/strong\u003e,\npackage, deploy the lambda and create the trigger event between S3 and the function.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eRun\u003c/strong\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sh\"\u003e./deploy-lambda.sh\u003c/code\u003e\u003c/pre\u003e\n\u003ch2\u003eAWS EKS Cluster\u003c/h2\u003e\n\u003cp\u003eThis step is optional if you already have it setup in your environment, and I also provide a sample file at \u003cstrong\u003e\u003ccode\u003eaquasec-log/kube-bench-report.json\u003c/code\u003e\u003c/strong\u003e that you can test the ingestion workflow without having to launche a new cluster.\u003c/p\u003e\n\u003cp\u003eFor this section you can follow the steps defined on \u003ca href=\"https://github.com/aquasecurity/kube-bench#running-in-an-eks-cluster\"\u003e\u003cstrong\u003ekube-bench\u003c/strong\u003e\u003c/a\u003e repository.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eNotice\u003c/strong\u003e: In the file \u003ccode\u003ejob-eks.yml\u003c/code\u003e at the \u003cstrong\u003ecommand\u003c/strong\u003e line add the \u003ccode\u003e--json\u003c/code\u003e flag to generate the correct output.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-sh\"\u003e\u003cspan class=\"hljs-built_in\"\u003ecommand\u003c/span\u003e: [\u003cspan class=\"hljs-string\"\u003e\"kube-bench\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"--version\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"1.11\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"--json\"\u003c/span\u003e]\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBased on the main repo guide you can find a sample deployment script here:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003edeploy-aws-eks.sh\u003c/code\u003e\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003eIntegration Test\u003c/h2\u003e\n\u003cp\u003eTo complete the integration test create a folder \u003cstrong\u003e\u003ccode\u003eload\u003c/code\u003e\u003c/strong\u003e inside of you \u003cstrong\u003eingestion bucket\u003c/strong\u003e and then \u003cstrong\u003eupload\u003c/strong\u003e the sample file:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eaquasec-log/kube-bench-report.json\u003c/code\u003e\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAfter the upload it should trigger the lambda and create a new index on Elastic Search.\u003c/p\u003e\n\u003cp\u003eAccess your \u003cstrong\u003eKibana\u003c/strong\u003e and check your new index there.\u003c/p\u003e\n\u003ch2\u003eCloud Cleanup\u003c/h2\u003e\n\u003cp\u003eAs we are using Cloudformation which track the changesets, you're able to rollback and delete any resource used. Go to the AWS Console and \u003cstrong\u003eCloud Formation\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003e#aws #aws-es #aws-eks #aws-lambda #aws-s3 #shell-script #python\u003c/p\u003e\n","ogImage":{"url":"/assets/blog/aws-elastic-search-aqua-security/cover.jpg"},"coverImage":"/assets/blog/aws-elastic-search-aqua-security/cover.jpg"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"aws-elastic-search-aqua-security"},"buildId":"sE5QJQumupB3fR0LDdfo0","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-e0a799dda1546678fa28.js"></script><script src="/_next/static/chunks/main-f00071751833783f30ee.js" async=""></script><script src="/_next/static/chunks/webpack-488dc228921f1fdbc0e7.js" async=""></script><script src="/_next/static/chunks/framework.d557686129d5a5cc0c94.js" async=""></script><script src="/_next/static/chunks/commons.c326fb833cc5579beb78.js" async=""></script><script src="/_next/static/chunks/pages/_app-f736c612c3a61f7a792b.js" async=""></script><script src="/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.d59a000dff2aebf41917.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-aa8a6a91975836f2c26b.js" async=""></script><script src="/_next/static/sE5QJQumupB3fR0LDdfo0/_buildManifest.js" async=""></script><script src="/_next/static/sE5QJQumupB3fR0LDdfo0/_ssgManifest.js" async=""></script></body></html>